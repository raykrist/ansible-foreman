---
- name: Foreman setup tasks
  hosts: "admin"

  vars:
    foreman_auth: &foreman_auth
      username: "{{ foreman_username }}"
      password: "{{ foreman_password }}"
      server_url: "{{ foreman_server_url }}"
      validate_certs: "{{ foreman_validate_certs | default('true') }}"

  tasks:

  - name: "Debug global parameters"
    debug:
      msg: "{{ item.name }}"
    loop: "{{ [foreman_global_parameter, foreman_override_global_parameter | default([{}])] |
              community.general.lists_mergeby('name',
                                              recursive=true,
                                              list_merge='prepend_rp') }}"
    loop_control:
      label: "{{ item.name }} => {{ item.value }}"

  - name: Set Global Parameters
    theforeman.foreman.global_parameter:
      <<: *foreman_auth
      state: "{{ item.state | default('present') }}"
      parameter_type: "{{ item.parameter_type | default(omit) }}"
      name: "{{ item.name }}"
      value: "{{ item.value | mandatory }}"
    loop: "{{ [foreman_global_parameter, foreman_override_global_parameter | default([{}])] |
              community.general.lists_mergeby('name',
                                              recursive=true,
                                              list_merge='prepend_rp') }}"
    loop_control:
      label: "{{ item.name }} => {{ item.value }}"

  - name: Sync os templates from git repo
    theforeman.foreman.templates_import:
      <<: *foreman_auth
      repo: "{{ foreman_template_repo }}"
      branch: "{{ foreman_template_branch }}"
      prefix: "{{ foreman_template_prefix }}"
      associate: "{{ foreman_template_associate }}"
      locations: "{{ foreman_locations | default('Default Location') }}"
      organizations: "{{ foreman_organizations | default('Default Organization') }}"

  - name: Setup installation medium
    theforeman.foreman.installation_medium:
      <<: *foreman_auth
      name: "{{ item.name | mandatory }}"
      path: "{{ item.path | mandatory }}"
      state: "{{ item.state | default('present') }}"
    loop: "{{ foreman_installation_medium | default([]) }}"
    loop_control:
      label: "{{ item.name }} => {{ item.path }}"

- name: Foreman setup roles ()
  hosts: "admin"
  gather_facts: no
  roles:
    - role: theforeman.foreman.settings
    - role: theforeman.foreman.domains
    - role: theforeman.foreman.subnets
    - role: theforeman.foreman.operatingsystems
      ignore_errors: "{{ ansible_check_mode }}"
    - role: theforeman.foreman.hostgroups
#    - role: theforeman.foreman.compute_profiles
#    - role: theforeman.foreman.compute_resources

- name: Foreman templates tasks
  hosts: "admin"
  gather_facts: no
  tasks:

  - name: "Create os template association"
    theforeman.foreman.os_default_template:
      <<: *foreman_auth
      operatingsystem: "{{ item.operatingsystem }}"
      template_kind: "{{ item.template_kind }}"
      provisioning_template: "{{ item.provisioning_templateÂ }}"
      state: "{{ item.state | default('present') }}"
    loop: "{{ foreman_os_default_templates | default([]) }}"
    loop_control:
      label: "{{ item.operatingsystem }} => {{ item.provisioning_template }}"
    ignore_errors: "{{ ansible_check_mode }}"

